version: 0.2
env:
  variables:
    DOCKERHUB_USERNAME: "fthwala2@oldmutual.com"
    DOCKERHUB_PASSWORD: "Thwalafelix19**"
phases:
  install:
    runtime-versions:
        nodejs: 20
    commands:
      - echo "Installing dependencies..."
      # - npm install
      - pip3 install -q awscli --upgrade --user
      - pip3 install boto3
      - sudo apt-get -qq install -y jq
      - wget -qO /tmp/sonar-scanner.zip "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.7.0.2747-linux.zip"
      - unzip -q /tmp/sonar-scanner.zip -d /tmp
      
  pre_build:
    commands:
      - echo Start code scan...
      - ./../../../../../../../tmp/sonar-scanner-4.7.0.2747-linux/bin/sonar-scanner -Dsonar.projectKey=$SONAR_QUBE_PROJECT -Dsonar.sources=. -Dsonar.host.url=$SONAR_QUBE_URL -Dsonar.login=$SONAR_QUBE_KEY
      - sleep 7
      - "curl -s -u $SONAR_QUBE_KEY: $SONAR_QUBE_URL/api/qualitygates/project_status?projectKey=$SONAR_QUBE_PROJECT> /tmp/result.json"
      - if [ $(jq -r '.projectStatus.status' /tmp/result.json) = ERROR ] ; then CODEBUILD_BUILD_SUCCEEDING=0 ; fi
      - echo Code scan completed on `date`
      - if [ "$CODEBUILD_BUILD_SUCCEEDING" -eq 0 ]; then exit 1; fi

      # - apt-get update -y
      # - apt-get install -y jp

      # - curl -o sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.2.2472-linux.zip
      # - unzip sonar-scanner.zip
      # - export PATH=$PATH:$(pwd)/sonar-scanner-4.6.2.2472-linux/bin
      # - sonar-scanner --version

  build:
    commands:
      - echo "Packaging Lambda function..."
      - zip -r whales_secured.zip .

      # - sonar-scanner \
      #     -Dsonar.projectKey=whales \
      #     -Dsonar.host.url=https://sonarcloud.io \
      #     -Dsonar.login=ffb630c42ea6b90fd4061be23343305ea85f93d8
      #     -Dsonar.organization=ntokozof

  post_build:
    commands:
      - echo "Deploying to AWS Lambda..."
      - aws lambda update-function-code --function-name whales_secured --zip-file fileb://whales_secured.zip
      - echo "Deployment completed."
      
# artifacts:
#   type: zip
#   files:
#     - whales_secured.zip 
#     - outputtemplate.yaml



